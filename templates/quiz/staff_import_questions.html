{% extends "quiz/base.html" %}
{% load dict_extras %}

{% block title %}Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©{% endblock %}

{% block extra_head %}
<style>
  .wrap{max-width:1100px;margin:0 auto;}
  .head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
  .sub{margin-top:6px;line-height:1.8}
  .glass{
    background:rgba(255,255,255,.78);
    border:1px solid rgba(231,238,246,.95);
    border-radius:22px;
    box-shadow: var(--shadow2);
  }
  .card2{padding:14px;}
  .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:12px;align-items:start;}
  @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
  .lbl{display:block;margin-bottom:6px;font-weight:900;color:var(--mut);font-size:12.2px;}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:10px 12px;border-radius:14px;
    border:1px solid rgba(231,238,246,.95);
    background:rgba(255,255,255,.92);
    font-weight:900;cursor:pointer;
    box-shadow: 0 10px 22px rgba(2,44,34,.05);
    text-decoration:none;color:inherit;
  }
  .btn.primary{
    background: linear-gradient(135deg, rgba(34,197,94,.16), rgba(14,165,164,.12));
    border-color: rgba(34,197,94,.22);
  }
  .btn.danger{
    background: linear-gradient(135deg, rgba(239,68,68,.12), rgba(244,63,94,.10));
    border-color: rgba(239,68,68,.22);
  }
  .mut{color:var(--mut);font-size:12.8px}
  .pill2{
    display:inline-flex;align-items:center;gap:8px;
    padding:7px 10px;border-radius:999px;
    border:1px solid rgba(231,238,246,.95);
    background: rgba(255,255,255,.86);
    font-weight:900;font-size:12px;
    white-space:nowrap;
  }
  .pill2.ok{
    background: rgba(34,197,94,.10);
    border-color: rgba(34,197,94,.25);
  }
  .pill2.bad{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.25);
  }
  .divider{height:1px;background:rgba(231,238,246,.95);margin:12px 0;}
  .table-wrap{width:100%;overflow:auto;border-radius:16px;border:1px solid rgba(231,238,246,.95);background:rgba(255,255,255,.92);}
  table{width:100%;border-collapse:collapse;font-size:13px;}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(231,238,246,.95);vertical-align:top;}
  th{background:rgba(2,44,34,.04);font-weight:900;white-space:nowrap;}
  tr:last-child td{border-bottom:none;}
  .err{margin-top:10px;border-radius:16px;border:1px dashed rgba(239,68,68,.35);background: rgba(239,68,68,.06);padding:10px}
  .okbox{margin-top:10px;border-radius:16px;border:1px dashed rgba(34,197,94,.35);background: rgba(34,197,94,.06);padding:10px}
  .ul{margin:8px 0 0 0;padding:0 18px;line-height:1.9}
  .hint{font-size:12.3px;color:var(--mut);line-height:1.9}
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head">
    <div>
      <h2 style="margin:0;font-weight:1000">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Excel</h2>
      <div class="sub mut">
        Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel (Ø¹Ø¯Ø© Ø´ÙŠØªØ§Øª) Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.
      </div>
    </div>

    <div class="row">
      <a class="btn" href="{% url 'quiz:staff_manage' %}">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
    </div>
  </div>

  {% if messages %}
    <div class="glass card2" style="margin-bottom:12px">
      {% for message in messages %}
        <div class="pill2 {% if message.tags == 'error' %}bad{% else %}ok{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="grid">

    <!-- Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù -->
    <div class="glass card2">
      <form method="post" enctype="multipart/form-data" class="row" style="align-items:flex-end;justify-content:space-between">
        {% csrf_token %}

        <div style="flex:1;min-width:260px">
          <label class="lbl">Ù…Ù„Ù Excel</label>
          <input type="file" name="file" accept=".xlsx,.xls" class="btn" style="width:100%;justify-content:flex-start" required>
          <div class="hint" style="margin-top:6px">
            * Ø§Ø±ÙØ¹ Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø´ÙŠØªØ§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø«Ù… Ø§Ø¶ØºØ· "Ù…Ø¹Ø§ÙŠÙ†Ø©" Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù„Ø§Ù…Ø©.
          </div>
        </div>

        <div class="row" style="justify-content:flex-end">
          <button type="submit" name="action" value="preview" class="btn primary">ğŸ‘€ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
          <button type="submit" name="action" value="import" class="btn">â¬‡ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
        </div>
      </form>
    </div>

    <!-- Ù…Ù„Ø®Øµ -->
    <div class="glass card2">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:1000">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</div>
          <div class="mut" style="margin-top:6px">Ø­Ø§Ù„Ø© ÙƒÙ„ Ø´ÙŠØª</div>
        </div>

        {% if reports %}
          {% if all_ok %}
            <span class="pill2 ok">âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
          {% else %}
            <span class="pill2 bad">â›” ÙŠÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡</span>
          {% endif %}
        {% else %}
          <span class="pill2">â€”</span>
        {% endif %}
      </div>

      {% if reports %}
        <div class="divider"></div>
        <div class="mut">Ø±Ø§Ø¬Ø¹ ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø´ÙŠØª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„</div>
      {% endif %}
    </div>

  </div>

  {% if preview %}
    {% for sheet, rows in preview.items %}
      <div class="glass card2" style="margin-top:12px">

        <div class="row" style="justify-content:space-between">
          <div class="row">

            {# ======= Ø­Ø³Ø§Ø¨ ok Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¶Ù…ÙˆÙ†Ø© Ø¨Ø¯ÙˆÙ† or ÙˆÙ„Ø§ Ø£Ù‚ÙˆØ§Ø³ ======= #}
            {% with rep=reports|get_item:sheet %}
              {% with ok1=rep.ok %}
                {% with ok2=rep|get_item:"ok" %}

                  {% if rep %}
                    {% if ok1 %}
                      <span class="pill2 ok">âœ… Ø´ÙŠØª: <b>{{ sheet }}</b></span>
                    {% else %}
                      {% if ok2 %}
                        <span class="pill2 ok">âœ… Ø´ÙŠØª: <b>{{ sheet }}</b></span>
                      {% else %}
                        <span class="pill2 bad">â›” Ø´ÙŠØª: <b>{{ sheet }}</b></span>
                      {% endif %}
                    {% endif %}
                  {% else %}
                    <span class="pill2 bad">â›” Ø´ÙŠØª: <b>{{ sheet }}</b></span>
                  {% endif %}

                {% endwith %}
              {% endwith %}
            {% endwith %}

            <span class="pill2">Ø¹Ø¯Ø¯: <b>{{ counts|get_item:sheet|default:0 }}</b></span>
          </div>

          <div class="row">
            {% with rep=reports|get_item:sheet %}
              {% with ok1=rep.ok %}
                {% with ok2=rep|get_item:"ok" %}
                  {% if rep %}
                    {% if ok1 %}
                      <span class="pill2 ok">Ø³Ù„ÙŠÙ…</span>
                    {% else %}
                      {% if ok2 %}
                        <span class="pill2 ok">Ø³Ù„ÙŠÙ…</span>
                      {% else %}
                        <span class="pill2 bad">ØºÙŠØ± Ø³Ù„ÙŠÙ…</span>
                      {% endif %}
                    {% endif %}
                  {% else %}
                    <span class="pill2 bad">ØºÙŠØ± Ø³Ù„ÙŠÙ…</span>
                  {% endif %}
                {% endwith %}
              {% endwith %}
            {% endwith %}
          </div>
        </div>

        <div class="divider"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                <th>Ø§Ù„ØµØ­ÙŠØ­</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for r in rows %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ r.question|default:"â€”" }}</td>
                  <td>{{ r.correct|default:"â€”" }}</td>
                  <td class="mut">{{ r.note|default:"" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="mut">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙÙˆÙ Ù„Ù„Ø¹Ø±Ø¶.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# ======= ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø®Ø·Ø§Ø¡/Ù†Ø¬Ø§Ø­ Ù„Ù„Ø´ÙŠØª ======= #}
        {% with rep=reports|get_item:sheet %}
          {% with ok1=rep.ok %}
            {% with ok2=rep|get_item:"ok" %}
              {% if rep %}
                {% if ok1 %}
                  <div class="okbox">
                    <div style="font-weight:1000;color:#14532d">âœ… Ø§Ù„Ø´ÙŠØª Ø³Ù„ÙŠÙ…</div>
                    <div class="mut" style="margin-top:6px">ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„.</div>
                  </div>
                {% else %}
                  {% if ok2 %}
                    <div class="okbox">
                      <div style="font-weight:1000;color:#14532d">âœ… Ø§Ù„Ø´ÙŠØª Ø³Ù„ÙŠÙ…</div>
                      <div class="mut" style="margin-top:6px">ÙŠÙ…ÙƒÙ† Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„.</div>
                    </div>
                  {% else %}
                    <div class="err">
                      <div style="font-weight:1000;color:#7f1d1d">Ø£Ø®Ø·Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠØª:</div>
                      <ul class="ul">
                        {% for e in rep.errors %}
                          <li>{{ e }}</li>
                        {% empty %}
                          {% for e in rep|get_item:"errors" %}
                            <li>{{ e }}</li>
                          {% empty %}
                            <li>Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.</li>
                          {% endfor %}
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                {% endif %}
              {% else %}
                <div class="err">
                  <div style="font-weight:1000;color:#7f1d1d">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ø±ÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠØª.</div>
                </div>
              {% endif %}
            {% endwith %}
          {% endwith %}
        {% endwith %}

      </div>
    {% endfor %}
  {% else %}
    <div class="glass card2" style="margin-top:12px">
      <div class="mut">Ø§Ø±ÙØ¹ Ù…Ù„Ù Excel Ø«Ù… Ø§Ø¶ØºØ· "Ù…Ø¹Ø§ÙŠÙ†Ø©".</div>
    </div>
  {% endif %}

</div>
{% endblock %}
