from __future__ import annotations

from django.contrib import messages
from django.contrib.admin.views.decorators import staff_member_required
from django.shortcuts import get_object_or_404, redirect, render
from django.views.decorators.http import require_http_methods

from .models import Attempt, Answer, Question


@staff_member_required
@require_http_methods(["GET"])
def staff_attempt_detail(request, attempt_id: int):
    """
    ✅ صفحة تفاصيل محاولة (للموظف)
    ملاحظة: لا نعتمد على quiz.question_set إطلاقاً لتفادي مشاكل reverse accessor
    """

    a = get_object_or_404(
        Attempt.objects.select_related("participant", "quiz"),
        id=attempt_id,
    )

    # ✅ الأسئلة عبر Query مباشر (بديل question_set)
    questions_qs = Question.objects.filter(quiz=a.quiz).order_by("order", "id")
    total = questions_qs.count()

    # ✅ الإجابات (مرتبة)
    answers = (
        Answer.objects.filter(attempt=a)
        .select_related("question", "selected_choice")
        .order_by("question__order", "id")
    )

    # ✅ answered count
    answered = answers.filter(answered_at__isnull=False).count()

    # ✅ نسبة إنجاز (لو تستخدمها في القالب)
    progress_pct = 0
    if total > 0:
        progress_pct = int(round((answered / total) * 100))

    ctx = {
        "a": a,
        "attempt": a,  # لو القالب يستخدم attempt
        "answers": answers,
        "total": total,
        "answered": answered,
        "progress_pct": progress_pct,
    }
    return render(request, "quiz/staff_attempt_detail.html", ctx)
