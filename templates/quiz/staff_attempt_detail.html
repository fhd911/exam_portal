{% extends "quiz/base.html" %}
{% block title %}تفاصيل المحاولة{% endblock %}

{% block content %}
<div class="sd-wrap">

  <div class="sd-head">
    <div>
      <h1 class="sd-title">تفاصيل المحاولة</h1>
      <p class="sd-sub">عرض معلومات المحاولة والإجابات بشكل رسمي.</p>
    </div>

    <div class="sd-actions">
      <a class="btn" href="{% url 'quiz:staff_manage' %}">الرجوع للوحة الإدارة</a>
    </div>
  </div>

  <!-- ✅ بطاقة المرشح الموحدة -->
  <div class="idcard">
    <div class="id-top">
      <div>
        <div class="id-title">بطاقة المرشح</div>
        <div class="id-sub">ملخص سريع للهوية قبل مراجعة الإجابات.</div>
      </div>

      <span class="pill {% if attempt.is_finished %}pill-ok{% else %}pill-warn{% endif %}">
        {% if attempt.is_finished %}منتهي{% else %}قيد التنفيذ{% endif %}
      </span>
    </div>

    <div class="id-grid">
      <div class="it">
        <div class="lk">الاسم</div>
        <div class="lv name">{{ attempt.participant.full_name|default:"-" }}</div>
      </div>

      <div class="it">
        <div class="lk">السجل المدني</div>
        <div class="lv">
          {% with nid=attempt.participant.national_id|default:"" %}
            {% if nid %}
              <span class="nid" dir="ltr">
                {% if nid|length >= 6 %}
                  {{ nid|slice:":3" }}******{{ nid|slice:"-2:" }}
                {% else %}
                  {{ nid }}
                {% endif %}
              </span>
            {% else %}—{% endif %}
          {% endwith %}
        </div>
      </div>

      <div class="it">
        <div class="lk">آخر 4 أرقام (الجوال)</div>
        <div class="lv">
          {% with p4=attempt.participant.phone_last4|default:"" %}
            {% if p4 %}
              <span class="nid" dir="ltr">{{ p4 }}</span>
            {% else %}—{% endif %}
          {% endwith %}
        </div>
      </div>
    </div>

    <div class="meta">
      <span class="m">
        المجال:
        <b>
          {% if attempt.display_domain %}
            {{ attempt.display_domain }}
          {% else %}
            {{ attempt.domain }}
          {% endif %}
        </b>
      </span>

      <span class="m">الدرجة: <b>{{ attempt.score|default:0 }}</b></span>

      <span class="m">البدء: <b>{{ attempt.started_at|date:"Y-m-d H:i" }}</b></span>

      {% if attempt.finished_at %}
        <span class="m">الانتهاء: <b>{{ attempt.finished_at|date:"Y-m-d H:i" }}</b></span>
      {% endif %}
    </div>
  </div>

  <!-- الإجابات -->
  <div class="card pad">
    <div class="ch">
      <div>
        <div class="ct">الإجابات</div>
        <div class="cs">عدد المُجاب: {{ answered }} / {{ total }} — التقدم: {{ progress_pct }}%</div>
      </div>
      <div class="badge">تفاصيل</div>
    </div>

    <div class="tbl">
      <table>
        <thead>
          <tr>
            <th style="width:72px;">#</th>
            <th>السؤال</th>
            <th style="width:220px;">الإجابة</th>
            <th style="width:120px;">صحيح؟</th>
          </tr>
        </thead>
        <tbody>
          {% for ans in answers %}
            <tr>
              <td>{{ forloop.counter }}</td>

              <td class="qtxt">{{ ans.question.text }}</td>

              <td>
                {% if ans.selected_choice %}
                  {{ ans.selected_choice.text }}
                {% else %}
                  — 
                {% endif %}
              </td>

              <td>
                {% if ans.selected_choice and ans.selected_choice.is_correct %}
                  <span class="tag ok">صحيح</span>
                {% else %}
                  <span class="tag no">غير صحيح</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="4">لا توجد بيانات.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block base_css_extra %}
  :root{
    --ok-bg: rgba(34,197,94,.08);
    --ok-bd: rgba(34,197,94,.18);
    --warn-bg: rgba(245,158,11,.10);
    --warn-bd: rgba(245,158,11,.22);
  }

  .sd-wrap{max-width:1180px;margin:0 auto}
  .sd-head{
    display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
    align-items:flex-start;margin:6px 0 12px
  }
  .sd-title{margin:0;font-size:18px;font-weight:750} /* ✅ أخف */
  .sd-sub{margin:6px 0 0;color:var(--mut);font-weight:600;line-height:1.9;font-size:13px}
  .sd-actions{display:flex;gap:8px;flex-wrap:wrap}

  /* ✅ بطاقة موحدة */
  .idcard{
    border:1px solid rgba(231,238,246,.95);
    background:rgba(255,255,255,.90);
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 22px rgba(15,23,42,.05);
    margin:0 0 12px;
  }
  .id-top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:10px}
  .id-title{font-weight:700} /* ✅ أخف */
  .id-sub{margin-top:4px;color:var(--mut);font-weight:600;font-size:12.5px;line-height:1.8}

  .pill{
    padding:7px 10px;border-radius:999px;
    border:1px solid rgba(231,238,246,.95);
    background:#fff;
    color:var(--txt);
    font-weight:650; /* ✅ أخف */
    font-size:12px;
    white-space:nowrap;
  }
  .pill-ok{background:var(--ok-bg);border-color:var(--ok-bd);color:#166534}
  .pill-warn{background:var(--warn-bg);border-color:var(--warn-bd);color:#7a4a00}

  .id-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media (max-width:900px){.id-grid{grid-template-columns:1fr}}
  .it{
    padding:10px 12px;border-radius:16px;
    background:#fff;border:1px solid rgba(231,238,246,.95);
  }
  .lk{color:var(--mut);font-weight:600;font-size:12px}
  .lv{margin-top:6px;font-weight:650;font-size:13px} /* ✅ أخف */
  .lv.name{font-size:14px}

  .nid{
    direction:ltr;
    unicode-bidi:isolate;
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(231,238,246,.95);
    background:rgba(255,255,255,.95);
    font-weight:650; /* ✅ بدل 800 */
    letter-spacing:.6px;
    font-variant-numeric: tabular-nums;
  }

  .meta{
    margin-top:10px;
    display:flex;gap:10px;flex-wrap:wrap;
    color:var(--mut);
    font-weight:600;
    font-size:12.5px
  }
  .meta .m b{color:var(--txt);font-weight:650} /* ✅ أخف */

  /* Table */
  .pad{padding:14px}
  .ch{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;margin-bottom:10px}
  .ct{font-weight:700} /* ✅ أخف */
  .cs{margin-top:4px;color:var(--mut);font-weight:600;font-size:12.5px;line-height:1.8}
  .badge{
    padding:7px 10px;border-radius:999px;
    background:rgba(2,132,199,.08);
    border:1px solid rgba(2,132,199,.16);
    font-weight:650; /* ✅ أخف */
    font-size:12px;white-space:nowrap;
  }

  .tbl{overflow:auto;border:1px solid rgba(231,238,246,.95);border-radius:14px;background:#fff}
  table{width:100%;border-collapse:collapse;font-size:12.5px}
  th,td{padding:10px 12px;border-bottom:1px solid rgba(231,238,246,.95);text-align:right;vertical-align:top}
  thead th{background:rgba(248,250,252,.9);font-weight:700} /* ✅ أخف */
  tr:last-child td{border-bottom:0}

  .qtxt{line-height:1.9;font-weight:600} /* ✅ أخف */

  .tag{
    display:inline-flex;align-items:center;justify-content:center;
    padding:6px 10px;border-radius:999px;
    font-weight:650; /* ✅ أخف */
    font-size:12px;
    border:1px solid rgba(231,238,246,.95);
    background:#fff;
  }
  .tag.ok{background:var(--ok-bg);border-color:var(--ok-bd);color:#166534}
  .tag.no{background:rgba(217,45,32,.08);border-color:rgba(217,45,32,.18);color:#8a1f17}
{% endblock %}
