{% extends "quiz/base.html" %}
{% block title %}تفاصيل المحاولة{% endblock %}

{% block content %}
<div class="wrap">
  <div class="top">
    <div>
      <h2>تفاصيل المحاولة #{{ attempt.id }}</h2>
      <p>{{ attempt.participant.full_name }} — هوية: {{ attempt.participant.national_id }} — {{ attempt.quiz.title }}</p>
    </div>
    <div class="actions">
      <a class="btn soft" href="{% url 'quiz:staff_manage' %}">رجوع</a>
      <a class="btn red" href="{% url 'quiz:staff_attempt_finish_confirm' attempt.id %}">إنهاء</a>
      <a class="btn" href="{% url 'quiz:staff_attempt_reset_confirm' attempt.id %}">إعادة فتح</a>
    </div>
  </div>

  <div class="cards">
    <div class="card">
      <div class="k">الحالة</div>
      <div class="v">{% if attempt.is_finished %}منتهي{% else %}جاري{% endif %}</div>
      <div class="s">السبب: {{ attempt.finished_reason|default:"—" }}</div>
    </div>

    <div class="card">
      <div class="k">الدرجة</div>
      <div class="v">{{ attempt.score|default:0 }}</div>
      <div class="s">انتهاء الوقت: {{ attempt.timed_out_count|default:0 }}</div>
    </div>

    <div class="card">
      <div class="k">الوقت</div>
      <div class="v">{{ attempt.started_at|date:"Y-m-d H:i" }}</div>
      <div class="s">انتهاء: {{ attempt.finished_at|date:"Y-m-d H:i"|default:"—" }}</div>
    </div>

    <div class="card">
      <div class="k">الجهاز</div>
      <div class="v">{{ attempt.started_ip|default:"—" }}</div>
      <div class="s">Session: {{ attempt.session_key|default:"—" }}</div>
    </div>
  </div>

  <div class="box">
    <div class="boxHead">
      <h3>الإجابات ({{ answers|length }})</h3>
      <div class="mini">يعرض السؤال + الإجابة المختارة + صح/خطأ إن توفر.</div>
    </div>

    <div class="tableWrap">
      <table class="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>السؤال</th>
            <th>الإجابة</th>
            <th>النتيجة</th>
            <th>بدء السؤال</th>
            <th>وقت الإجابة</th>
          </tr>
        </thead>
        <tbody>
          {% for x in answers %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="q">{{ x.question.text|default:"—" }}</td>
              <td class="a">
                {% if x.selected_choice %}
                  {{ x.selected_choice.text }}
                {% else %}
                  <span class="chip warn">بدون إجابة</span>
                {% endif %}
              </td>
              <td>
                {% if x.selected_choice and x.selected_choice.is_correct %}
                  <span class="chip ok">صحيح</span>
                {% elif x.selected_choice %}
                  <span class="chip bad">خطأ</span>
                {% else %}
                  <span class="chip warn">—</span>
                {% endif %}
              </td>
              <td class="mut">{{ x.started_at|date:"H:i:s"|default:"—" }}</td>
              <td class="mut">{{ x.answered_at|date:"H:i:s"|default:"—" }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="empty">لا توجد إجابات.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
  .wrap{max-width:1250px;margin:0 auto;padding:12px 10px 44px}
  .top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-bottom:12px}
  h2{margin:0;font-size:18px;font-weight:1200}
  p{margin:6px 0 0;color:var(--mut);font-weight:1000;line-height:1.9}
  .actions{display:flex;gap:8px;flex-wrap:wrap}

  .btn{border:0;border-radius:999px;padding:9px 12px;font-weight:1200;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;background:#0ea5e9;color:#fff}
  .btn.soft{background:#eef6ff;color:#0b4c7a;border:1px solid rgba(15,23,42,.08)}
  .btn.red{background:#fff1f2;color:#9f1239;border:1px solid rgba(159,18,57,.18)}

  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
  @media (max-width:1100px){.cards{grid-template-columns:repeat(2,1fr)}}
  .card{background:#fff;border:1px solid rgba(231,238,246,.95);border-radius:20px;padding:12px;box-shadow:0 12px 28px rgba(2,44,34,.06)}
  .k{font-size:12px;color:var(--mut);font-weight:1100}
  .v{margin-top:6px;font-size:16px;font-weight:1300}
  .s{margin-top:6px;font-size:12px;color:var(--mut);font-weight:1000}

  .box{background:#fff;border:1px solid rgba(231,238,246,.95);border-radius:22px;padding:12px;box-shadow:0 16px 34px rgba(2,44,34,.06)}
  .boxHead{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end}
  h3{margin:0;font-size:16px;font-weight:1200}
  .mini{color:var(--mut);font-weight:1000;font-size:12px}

  .tableWrap{margin-top:10px;border-radius:18px;border:1px solid rgba(231,238,246,.95);overflow:auto}
  .tbl{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
  .tbl thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid rgba(15,23,42,.08);padding:10px;font-size:12px;font-weight:1200;white-space:nowrap}
  .tbl tbody td{border-bottom:1px solid rgba(15,23,42,.06);padding:10px;font-weight:1000;font-size:12.8px;vertical-align:top}
  .q{line-height:1.9}
  .a{line-height:1.9}

  .chip{display:inline-flex;align-items:center;justify-content:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(15,23,42,.10);font-weight:1200;font-size:12px}
  .chip.ok{background:#ecfdf5;color:#065f46;border-color:rgba(6,95,70,.16)}
  .chip.bad{background:#fff1f2;color:#9f1239;border-color:rgba(159,18,57,.16)}
  .chip.warn{background:#fff7ed;color:#9a3412;border-color:rgba(154,52,18,.16)}
  .mut{color:var(--mut);font-weight:1000}
  .empty{text-align:center;padding:18px;color:var(--mut);font-weight:1100}
</style>
{% endblock %}
