{% extends "quiz/base.html" %}
{% block title %}تفاصيل المحاولة{% endblock %}

{% block extra_head %}
<style>
  .head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px;}
  .sub{margin-top:6px;line-height:1.9}
  .glass{background:rgba(255,255,255,.78);border:1px solid rgba(231,238,246,.95);border-radius:22px;box-shadow: var(--shadow2);}
  .meta{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  @media (max-width: 980px){ .meta{grid-template-columns:repeat(2,minmax(0,1fr));} }
  @media (max-width: 540px){ .meta{grid-template-columns:1fr;} }
  .kpi{
    border-radius:18px;padding:12px;
    background:
      radial-gradient(420px 150px at 0% 0%, rgba(14,165,164,.10), transparent 55%),
      radial-gradient(420px 150px at 100% 0%, rgba(16,185,129,.10), transparent 55%),
      #fff;
    border:1px solid rgba(231,238,246,.95);
    box-shadow:var(--shadow2);
  }
  .kpi b{font-size:18px}
  .mut{color:var(--mut)}
  .pill{
    display:inline-flex;align-items:center;gap:8px;padding:5px 10px;border-radius:999px;
    font-size:11.5px;font-weight:900;border:1px solid rgba(231,238,246,.95);background:#fff;color:var(--mut)
  }
  .pill.ok{background:rgba(16,185,129,.10);border-color:rgba(16,185,129,.25);color:#065f46}
  .pill.warn{background:rgba(245,158,11,.10);border-color:rgba(245,158,11,.25);color:#7c2d12}
  .table-wrap{overflow:auto;padding-bottom:8px;}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid rgba(231,238,246,.95);vertical-align:top}
  thead th{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter: blur(8px);z-index:1}
  .btn.soft{background:#fff;color:var(--ink);border:1px solid rgba(231,238,246,.95);box-shadow:none;}
  .btn.soft:hover{background:rgba(14,165,164,.04);}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="head">
    <div>
      <h2 style="margin:0">تفاصيل المحاولة</h2>
      <div class="mut sub">عرض كامل لأسئلة وإجابات المترشح + حالة التأخر.</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a class="btn soft" href="{% url 'quiz:staff_manage' %}">رجوع للوحة</a>
    </div>
  </div>

  <div class="glass" style="padding:12px">
    <div class="meta">
      <div class="kpi">
        <div class="mut">المترشح</div>
        <b>{{ attempt.participant.full_name|default:"—" }}</b>
        <div class="mut" style="margin-top:6px">{{ attempt.participant.national_id }}</div>
      </div>
      <div class="kpi">
        <div class="mut">المجال</div>
        <b>{{ attempt.participant.domain }}</b>
        <div class="mut" style="margin-top:6px">({% if attempt.participant.domain == "deputy" %}وكيل{% elif attempt.participant.domain == "counselor" %}موجه طلابي{% else %}رائد نشاط{% endif %})</div>
      </div>
      <div class="kpi">
        <div class="mut">الاختبار</div>
        <b>{{ attempt.quiz.title }}</b>
        <div class="mut" style="margin-top:6px">الدرجة: <b>{{ attempt.score }}</b></div>
      </div>
      <div class="kpi">
        <div class="mut">الحالة</div>
        <b>
          {% if attempt.is_finished %}
            <span class="pill ok">منتهي</span>
          {% else %}
            <span class="pill warn">جارٍ</span>
          {% endif %}
        </b>
        <div class="mut" style="margin-top:6px">
          بدأ: {{ attempt.started_at|date:"Y-m-d H:i" }}<br>
          انتهى: {% if attempt.finished_at %}{{ attempt.finished_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}
        </div>
      </div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div class="table-wrap scroll-x">
      <table>
        <thead>
          <tr class="mut">
            <th style="min-width:90px;">#</th>
            <th style="min-width:420px;">السؤال</th>
            <th style="min-width:320px;">الإجابة المختارة</th>
            <th style="min-width:120px;">صحيح؟</th>
            <th style="min-width:120px;">متأخر؟</th>
            <th style="min-width:220px;">وقت الإجابة</th>
          </tr>
        </thead>
        <tbody>
          {% for a in answers %}
            <tr>
              <td><b>{{ forloop.counter }}</b></td>
              <td>{{ a.question.text }}</td>
              <td>
                {% if a.selected_choice %}
                  <b>{{ a.selected_choice.text }}</b>
                {% else %}
                  <span class="mut">— لم يجب —</span>
                {% endif %}
              </td>
              <td>
                {% if a.selected_choice and a.selected_choice.is_correct %}
                  <span class="pill ok">نعم</span>
                {% else %}
                  <span class="pill">لا</span>
                {% endif %}
              </td>
              <td>
                {% if a.is_late %}
                  <span class="pill warn">متأخر</span>
                {% else %}
                  <span class="pill ok">ضمن الوقت</span>
                {% endif %}
              </td>
              <td class="mut">
                بدأ: {{ a.started_at|date:"Y-m-d H:i:s" }}<br>
                أجاب: {% if a.answered_at %}{{ a.answered_at|date:"Y-m-d H:i:s" }}{% else %}—{% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="mut" style="padding:14px;">لا توجد إجابات لهذه المحاولة.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
