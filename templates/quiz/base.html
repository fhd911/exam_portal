{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}منصة الاختبارات{% endblock %}</title>

  <!-- Cairo -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ff:"Cairo",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      --bg:#f7f9fc;
      --card:#ffffff;
      --txt:#0f172a;
      --mut:#607185;
      --line:#e7eef6;
      --btn:#0b3a6a;
      --btn2:#0f4c81;
      --danger:#b42318;
      --danger2:#d92d20;
      --shadow:0 10px 28px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--ff);
      background:var(--bg);
      color:var(--txt);
    }

    .page{min-height:100%;display:flex;flex-direction:column}

    .topbar{
      background:rgba(255,255,255,.9);
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .topbar .inner{
      max-width:1180px;
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:240px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg,#0b3a6a,#11a3c7);
      box-shadow:0 10px 22px rgba(17,163,199,.22);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;letter-spacing:.5px;user-select:none;
    }
    .brand-txt{display:flex;flex-direction:column;line-height:1.2}
    .brand-txt b{font-size:13px;font-weight:900;letter-spacing:.2px}
    .brand-txt span{font-size:11px;color:var(--mut);margin-top:2px}

    .nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    .btn{
      font-family:var(--ff);
      border:1px solid var(--line);
      background:#fff;
      color:var(--txt);
      padding:8px 12px;
      border-radius:12px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.15s ease;
      box-shadow:0 1px 0 rgba(15,23,42,.03);
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 10px 20px rgba(15,23,42,.06)}
    .btn-primary{
      background:linear-gradient(135deg,var(--btn),var(--btn2));
      border-color:transparent;
      color:#fff;
    }
    .btn-danger{
      background:linear-gradient(135deg,var(--danger),var(--danger2));
      border-color:transparent;
      color:#fff;
    }

    .container{
      max-width:1180px;
      margin:0 auto;
      padding:14px;
      width:100%;
      flex:1;
    }

    .msgs{max-width:1180px;margin:0 auto;padding:0 14px 8px}
    .msg{
      background:#fff;border:1px solid var(--line);
      border-radius:14px;padding:10px 12px;margin-top:8px;
      box-shadow:0 8px 18px rgba(15,23,42,.05);
      font-size:12px;line-height:1.7;
    }
    .msg.success{border-color:rgba(34,197,94,.35)}
    .msg.error{border-color:rgba(217,45,32,.35)}
    .msg.warning{border-color:rgba(245,158,11,.35)}
    .msg.info{border-color:rgba(59,130,246,.35)}

    .footer{border-top:1px solid var(--line);background:#fff}
    .footer .inner{
      max-width:1180px;margin:0 auto;padding:10px 14px;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      color:var(--mut);font-size:11px;
    }

    /* ✅ تنظيف: اجعل أزرار الفورم لا تغير المسافات */
    .nav form{margin:0;display:inline}
    .nav form button{appearance:none}
  </style>

  <style id="page-extra-css">
    {% block base_css_extra %}{% endblock %}
  </style>
</head>

<body>
  <div class="page">

    <header class="topbar">
      <div class="inner">
        <div class="brand">
          <div class="logo">✓</div>
          <div class="brand-txt">
            <b>منصة الاختبارات</b>
            <span>نظام موحّد لإدارة تنفيذ الاختبارات</span>
          </div>
        </div>

        <nav class="nav">
          <a class="btn" href="{% url 'quiz:home' %}">الرئيسية</a>

          {# ✅ إعادة ضبط: للستاف دائمًا، وللمرشح فقط قبل بدء الاختبار (قبل confirm) #}
          {% if request.user.is_authenticated and request.user.is_staff %}
            <form method="post" action="{% url 'quiz:reset_session' %}">
              {% csrf_token %}
              <button class="btn" type="submit">إعادة ضبط</button>
            </form>
          {% elif request.session.participant_id and not request.session.attempt_id %}
            <form method="post" action="{% url 'quiz:reset_session' %}">
              {% csrf_token %}
              <button class="btn" type="submit">إعادة ضبط</button>
            </form>
          {% endif %}

          {% if request.user.is_authenticated and request.user.is_staff %}
            <a class="btn" href="{% url 'quiz:staff_manage' %}">لوحة الإدارة</a>

            {# ✅ خروج الإدارة: POST فقط لتجنب 405 #}
            <form method="post" action="{% url 'quiz:staff_logout' %}">
              {% csrf_token %}
              <button class="btn btn-danger" type="submit">خروج الإدارة</button>
            </form>

          {% elif request.session.participant_id %}
            <form method="post" action="{% url 'quiz:logout' %}">
              {% csrf_token %}
              <button class="btn btn-danger" type="submit">خروج</button>
            </form>
          {% endif %}
        </nav>
      </div>
    </header>

    {% if messages %}
      <div class="msgs">
        {% for m in messages %}
          <div class="msg {% if m.tags %}{{ m.tags }}{% endif %}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <main class="container">
      {% block frame_open %}{% endblock %}
      {% block content %}{% endblock %}
      {% block frame_close %}{% endblock %}
    </main>

    <footer class="footer">
      <div class="inner">
        <div>© منصة الاختبارات</div>
      </div>
    </footer>

  </div>

  {% block base_js_extra %}{% endblock %}
</body>
</html>
