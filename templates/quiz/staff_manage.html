{# templates/quiz/staff_manage.html #}
{% extends "quiz/base.html" %}
{% load static %}

{% block title %}لوحة الإدارة — المحاولات{% endblock %}

{% block base_css_extra %}
  /* =========================================
     BI / Scientific Admin Dashboard (RTL)
     - أنحف + أصغر + احترافي
     - بدون تمرير أفقي
     IMPORTANT: لا تضع <style> داخل هذا البلوك
     ========================================= */

  :root{
    --bi-bg0:#f7fbff;
    --bi-bg1:#f3f8ff;
    --bi-card: rgba(255,255,255,.88);
    --bi-bdr: rgba(226,232,240,.92);

    --bi-txt:#0f172a;
    --bi-mut:#64748b;

    --bi-pri:#2563eb;
    --bi-ok:#16a34a;
    --bi-warn:#d97706;
    --bi-bad:#dc2626;

    --bi-shadow: 0 14px 44px rgba(2,6,23,.07);
    --bi-shadow2: 0 10px 22px rgba(2,6,23,.05);
    --bi-ring: 0 0 0 4px rgba(37,99,235,.11);

    --bi-r:18px;
  }

  /* لا نلمس .wrap في base.html — نخلي التخطيط داخل الصفحة */
  .bi-wrap{max-width:1380px;margin:0 auto;padding:0 8px;}
  .bi-shell{
    background:
      radial-gradient(900px 320px at 80% -40px, rgba(37,99,235,.09), transparent 55%),
      radial-gradient(700px 260px at 10% -40px, rgba(22,163,74,.07), transparent 55%),
      linear-gradient(180deg, var(--bi-bg0), var(--bi-bg1));
    border-radius: 26px;
    padding: 14px;
    box-shadow: var(--bi-shadow);
    border: 1px solid rgba(226,232,240,.88);
  }

  /* Header */
  .bi-head{
    display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
    margin-bottom: 10px;
  }
  .bi-title h1{
    margin:0;
    font-size:16px;
    font-weight:900;
    color:var(--bi-txt);
    letter-spacing:.1px;
  }
  .bi-title p{
    margin:6px 0 0;
    line-height:1.85;
    color:var(--bi-mut);
    font-weight:700;
    font-size:12.2px;
  }

  /* Top actions */
  .bi-tools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .bi-btn{
    appearance:none;
    border:1px solid var(--bi-bdr);
    background: rgba(255,255,255,.86);
    padding:8px 11px;
    border-radius:999px;
    cursor:pointer;
    font-weight:900;
    font-size:12.2px;
    color:var(--bi-txt);
    box-shadow: 0 6px 14px rgba(2,6,23,.045);
    transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    display:inline-flex;align-items:center;gap:8px;
    white-space:nowrap;
    text-decoration:none;
  }
  .bi-btn:hover{
    transform: translateY(-1px);
    box-shadow: var(--bi-shadow2);
    border-color: rgba(37,99,235,.22);
    background: rgba(255,255,255,.92);
  }
  .bi-btn:focus{outline:none; box-shadow: var(--bi-shadow2), var(--bi-ring);}

  .bi-btn.red{border-color: rgba(220,38,38,.22); color:#b91c1c}
  .bi-btn.blue{border-color: rgba(37,99,235,.24); color: #1d4ed8}
  .bi-btn.green{border-color: rgba(22,163,74,.22); color:#15803d}

  .bi-tag{
    font-size:10.6px;
    font-weight:1000;
    padding:3px 7px;
    border-radius:999px;
    background: rgba(2,6,23,.045);
    color: var(--bi-mut);
  }

  /* Card blocks */
  .bi-card{
    background: var(--bi-card);
    border: 1px solid var(--bi-bdr);
    border-radius: 22px;
    box-shadow: var(--bi-shadow2);
    overflow:hidden;
  }
  .bi-pad{padding:12px}

  /* KPI strip */
  .bi-kpi-grid{
    display:grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap:10px;
  }
  @media (max-width: 1120px){
    .bi-kpi-grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
  }
  .bi-kpi{
    border:1px solid rgba(226,232,240,.92);
    border-radius: 18px;
    padding: 10px 11px;
    background:
      radial-gradient(220px 86px at 15% 0%, rgba(37,99,235,.08), transparent 60%),
      linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    min-height:68px;
  }
  .bi-kpi .lab{color:var(--bi-mut);font-weight:900;font-size:11.6px}
  .bi-kpi .val{color:var(--bi-txt);font-weight:1000;font-size:16px}
  .bi-kpi .mini{color:var(--bi-mut);font-weight:900;font-size:10.6px;margin-top:3px}
  .bi-ic{
    width:38px;height:38px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    background: rgba(37,99,235,.09);
    border:1px solid rgba(37,99,235,.16);
    font-weight:1000;color: #1d4ed8;
    flex:0 0 auto;
  }
  .bi-ic.ok{background: rgba(22,163,74,.09); border-color: rgba(22,163,74,.16); color:#15803d}
  .bi-ic.w{background: rgba(217,119,6,.09); border-color: rgba(217,119,6,.16); color:#b45309}
  .bi-ic.g{background: rgba(2,6,23,.05); border-color: rgba(2,6,23,.09); color:#334155}

  /* Filters */
  .bi-filters{
    display:grid;
    grid-template-columns: 2.3fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
    gap:10px;
    align-items:end;
  }
  @media (max-width: 1180px){
    .bi-filters{grid-template-columns: 1fr 1fr;}
  }

  .bi-f{display:flex;flex-direction:column;gap:6px;}
  .bi-lbl{font-size:11.6px;color:var(--bi-mut);font-weight:900}

  .bi-in, .bi-sel{
    height:38px;
    border-radius:14px;
    border:1px solid rgba(226,232,240,.92);
    background: rgba(255,255,255,.92);
    padding:0 11px;
    font-weight:900;
    color:var(--bi-txt);
    outline:none;
    transition: box-shadow .12s ease, border-color .12s ease, background .12s ease;
    width:100%;
    font-size:12.2px;
  }
  .bi-sel{padding-inline-start:10px}
  .bi-in:focus,.bi-sel:focus{box-shadow: var(--bi-ring); border-color: rgba(37,99,235,.32)}
  .bi-btnrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .bi-btn.sm{padding:8px 13px;font-size:12px}

  /* Table (لا تمرير أفقي) */
  .bi-table-wrap{overflow-x:hidden;}
  .bi-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    table-layout: fixed;
  }
  .bi-table thead th{
    text-align:right;
    font-size:11.4px;
    color: var(--bi-mut);
    font-weight:1000;
    padding: 9px 10px;
    background: rgba(241,245,249,.72);
    border-bottom:1px solid rgba(226,232,240,.92);
  }
  .bi-table tbody td{
    padding: 11px 10px;
    border-bottom: 1px solid rgba(226,232,240,.88);
    vertical-align: middle;
    color: var(--bi-txt);
    font-weight:800;
    font-size:12.6px;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .bi-table tbody tr:hover td{background: rgba(37,99,235,.032)}

  /* Column widths */
  th.col-p, td.col-p{width: 28%;}
  th.col-dom, td.col-dom{width: 10%;}
  th.col-quiz, td.col-quiz{width: 10%;}
  th.col-st, td.col-st{width: 10%;}
  th.col-prog, td.col-prog{width: 16%;}
  th.col-score, td.col-score{width: 8%;}
  th.col-time, td.col-time{width: 10%;}
  th.col-ip, td.col-ip{width: 8%;}
  th.col-act, td.col-act{width: 10%;}

  @media (max-width: 980px){
    th.col-ip, td.col-ip{display:none;}
    th.col-time, td.col-time{display:none;}
    th.col-act, td.col-act{width: 18%;}
    th.col-p, td.col-p{width: 40%;}
  }

  /* Participant cell */
  .bi-pname{display:flex;flex-direction:column;gap:3px;min-width:0}
  .bi-pname .n{font-weight:1000;color:var(--bi-txt);overflow:hidden;text-overflow:ellipsis}
  .bi-pname .s{font-weight:800;color:var(--bi-mut);font-size:11.4px}

  /* Chips */
  .bi-chip{
    display:inline-flex;align-items:center;gap:7px;
    padding:6px 9px;border-radius:999px;
    border:1px solid rgba(226,232,240,.92);
    background: rgba(255,255,255,.90);
    font-weight:900;
    font-size:11.6px;
    color: var(--bi-txt);
    max-width:100%;
  }
  .bi-dot{width:7px;height:7px;border-radius:99px;background: rgba(100,116,139,.9)}
  .bi-chip.ok{border-color: rgba(22,163,74,.24); background: rgba(22,163,74,.06); color:#14532d}
  .bi-chip.w{border-color: rgba(217,119,6,.24); background: rgba(217,119,6,.07); color:#7c2d12}
  .bi-chip.bad{border-color: rgba(220,38,38,.24); background: rgba(220,38,38,.07); color:#7f1d1d}
  .bi-chip.blue{border-color: rgba(37,99,235,.22); background: rgba(37,99,235,.055); color:#1d4ed8}

  /* Progress */
  .bi-prog{display:flex;align-items:center;gap:10px;min-width:0;}
  .bi-bar{
    flex:1;
    height:10px;border-radius:999px;
    background: rgba(148,163,184,.20);
    border:1px solid rgba(226,232,240,.88);
    overflow:hidden;
  }
  .bi-bar > span{
    display:block;height:100%;
    background: linear-gradient(90deg, rgba(37,99,235,.95), rgba(29,78,216,.84));
    width:0%;
  }
  .bi-prog .t{font-size:11.4px;color:var(--bi-mut);font-weight:1000}
  .bi-prog .b{font-size:11.6px;color:var(--bi-txt);font-weight:1000}

  /* Actions in table */
  .bi-act{display:flex;gap:8px;flex-wrap:wrap}
  .bi-act .bi-btn{padding:7px 10px;font-size:11.8px}

  /* Pagination */
  .bi-pager{
    display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
    padding: 10px 12px;
    border-top: 1px solid rgba(226,232,240,.85);
    background: rgba(255,255,255,.55);
  }
  .bi-pager .info{color:var(--bi-mut);font-weight:900;font-size:11.8px}
  .bi-pbtn{
    padding:8px 11px;border-radius:12px;border:1px solid var(--bi-bdr);
    background: rgba(255,255,255,.90);
    font-weight:900;color:var(--bi-txt);
    text-decoration:none;
    display:inline-flex;
  }

  /* Mobile spacing */
  @media (max-width: 640px){
    .bi-shell{padding:12px;border-radius:22px;}
    .bi-pad{padding:12px;}
    .bi-tools{gap:6px}
    .bi-btn{padding:7px 10px;font-size:12px}
  }
{% endblock %}

{% block content %}
<div class="bi-wrap">
  <div class="bi-shell">

    <div class="bi-head">
      <div class="bi-title">
        <h1>لوحة الإدارة — المحاولات</h1>
        <p>عرض إحصائي: مؤشرات KPI + فلاتر + جدول ثابت الأعمدة (بدون تمرير أفقي).</p>
      </div>

      <div class="bi-tools">
        <a class="bi-btn red" href="{% url 'quiz:staff_logout' %}"><span class="bi-tag">Logout</span> خروج</a>
        <a class="bi-btn" href="{% url 'quiz:staff_manage' %}"><span class="bi-tag">Reset</span> تصفير الفلاتر</a>
        <a class="bi-btn blue" href="{% url 'quiz:staff_export_csv' %}"><span class="bi-tag">CSV</span> تصدير CSV</a>
        <a class="bi-btn blue" href="{% url 'quiz:staff_export_xlsx' %}"><span class="bi-tag">XLSX</span> تصدير XLSX</a>
        <a class="bi-btn green" href="{% url 'quiz:staff_import_questions' %}"><span class="bi-tag">Sheets 3</span> استيراد الأسئلة</a>
        <a class="bi-btn green" href="{% url 'quiz:staff_import_participants' %}"><span class="bi-tag">XLSX</span> استيراد المرشحين</a>
      </div>
    </div>

    <div class="bi-card">
      <div class="bi-pad">

        <!-- KPI -->
        <div class="bi-kpi-grid">
          <div class="bi-kpi">
            <div>
              <div class="lab">إجمالي النتائج (ضمن الفلاتر)</div>
              <div class="val">{{ kpi.total }}</div>
              <div class="mini">N</div>
            </div>
            <div class="bi-ic g">Σ</div>
          </div>

          <div class="bi-kpi">
            <div>
              <div class="lab">مكتملة</div>
              <div class="val">{{ kpi.finished }}</div>
              <div class="mini">Finished</div>
            </div>
            <div class="bi-ic ok">✓</div>
          </div>

          <div class="bi-kpi">
            <div>
              <div class="lab">جارية</div>
              <div class="val">{{ kpi.running }}</div>
              <div class="mini">Running</div>
            </div>
            <div class="bi-ic w">⏳</div>
          </div>

          <div class="bi-kpi">
            <div>
              <div class="lab">متوسط الدرجة (المنتهية)</div>
              <div class="val">{{ kpi.avg_score }}</div>
              <div class="mini">Mean</div>
            </div>
            <div class="bi-ic">μ</div>
          </div>

          <div class="bi-kpi">
            <div>
              <div class="lab">عدد الأسئلة</div>
              <div class="val">{{ total_questions|default:50 }}</div>
              <div class="mini">Total Q</div>
            </div>
            <div class="bi-ic g">Q</div>
          </div>
        </div>

        <div style="height:10px"></div>

        <!-- Filters -->
        <form method="get" class="bi-filters">
          <div class="bi-f">
            <div class="bi-lbl">بحث (هوية/اسم)</div>
            <input class="bi-in" name="q" value="{{ filters.q }}" placeholder="اكتب رقم الهوية أو الاسم">
          </div>

          <div class="bi-f">
            <div class="bi-lbl">الحالة</div>
            <select class="bi-sel" name="status">
              <option value="all" {% if filters.status == "all" %}selected{% endif %}>الكل</option>
              <option value="finished" {% if filters.status == "finished" %}selected{% endif %}>مكتمل</option>
              <option value="running" {% if filters.status == "running" %}selected{% endif %}>جاري</option>
            </select>
          </div>

          <div class="bi-f">
            <div class="bi-lbl">المجال</div>
            <select class="bi-sel" name="domain">
              <option value="" {% if not filters.domain %}selected{% endif %}>الكل</option>
              <option value="deputy" {% if filters.domain == "deputy" %}selected{% endif %}>وكيل</option>
              <option value="counselor" {% if filters.domain == "counselor" %}selected{% endif %}>موجه طلابي</option>
              <option value="activity" {% if filters.domain == "activity" %}selected{% endif %}>رائد نشاط</option>
            </select>
          </div>

          <div class="bi-f">
            <div class="bi-lbl">الاختبار</div>
            <select class="bi-sel" name="quiz">
              <option value="" {% if not filters.quiz %}selected{% endif %}>الكل</option>
              {% for qz in quizzes %}
                <option value="{{ qz.id }}" {% if filters.quiz == qz.id|stringformat:"s" %}selected{% endif %}>{{ qz.title }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="bi-f">
            <div class="bi-lbl">سبب الإنهاء</div>
            <select class="bi-sel" name="fr">
              <option value="" {% if not filters.fr %}selected{% endif %}>الكل</option>
              <option value="normal" {% if filters.fr == "normal" %}selected{% endif %}>طبيعي</option>
              <option value="timeout" {% if filters.fr == "timeout" %}selected{% endif %}>انتهاء وقت</option>
              <option value="forced" {% if filters.fr == "forced" %}selected{% endif %}>إداري</option>
            </select>
          </div>

          <div class="bi-f">
            <div class="bi-lbl">من تاريخ</div>
            <input class="bi-in" type="date" name="from" value="{{ filters.from }}">
          </div>

          <div class="bi-f">
            <div class="bi-lbl">إلى تاريخ</div>
            <input class="bi-in" type="date" name="to" value="{{ filters.to }}">
          </div>

          <div class="bi-f">
            <div class="bi-lbl">ترتيب</div>
            <select class="bi-sel" name="sort">
              <option value="-started_at" {% if filters.sort == "-started_at" %}selected{% endif %}>الأحدث</option>
              <option value="started_at" {% if filters.sort == "started_at" %}selected{% endif %}>الأقدم</option>
              <option value="-score" {% if filters.sort == "-score" %}selected{% endif %}>الأعلى درجة</option>
              <option value="score" {% if filters.sort == "score" %}selected{% endif %}>الأقل درجة</option>
            </select>
          </div>

          <div class="bi-btnrow">
            <button class="bi-btn blue sm" type="submit">تطبيق</button>
            <a class="bi-btn sm" href="{% url 'quiz:staff_manage' %}">مسح</a>
          </div>
        </form>

        <div style="height:12px"></div>

        <!-- Table -->
        <div class="bi-table-wrap">
          <table class="bi-table">
            <thead>
              <tr>
                <th class="col-p">المشارك</th>
                <th class="col-dom">المجال</th>
                <th class="col-quiz">الاختبار</th>
                <th class="col-st">الحالة</th>
                <th class="col-prog">التقدم</th>
                <th class="col-score">الدرجة</th>
                <th class="col-time">الوقت</th>
                <th class="col-ip">IP</th>
                <th class="col-act">إجراءات</th>
              </tr>
            </thead>

            <tbody>
              {% for a in attempts %}
                <tr>
                  <td class="col-p">
                    <div class="bi-pname">
                      <div class="n">{{ a.participant.full_name }}</div>
                      <div class="s">هوية: {{ a.participant.national_id }}</div>
                    </div>
                  </td>

                  <td class="col-dom">
                    <span class="bi-chip blue"><span class="bi-dot"></span>{{ a.domain_label }}</span>
                  </td>

                  <td class="col-quiz">
                    <span class="bi-chip"><span class="bi-dot"></span>{{ a.quiz.title }}</span>
                  </td>

                  <td class="col-st">
                    {% if a.is_finished %}
                      <span class="bi-chip ok"><span class="bi-dot" style="background:rgba(22,163,74,.9)"></span>مكتمل</span>
                    {% else %}
                      <span class="bi-chip w"><span class="bi-dot" style="background:rgba(217,119,6,.9)"></span>جاري</span>
                    {% endif %}
                  </td>

                  <td class="col-prog">
                    <div class="bi-prog">
                      <div class="bi-bar">
                        <span style="width: {{ a.progress_pct|default:0 }}%"></span>
                      </div>
                      <div style="display:flex;flex-direction:column;gap:2px;min-width:108px">
                        <div class="b">{{ a.current_index|default:0 }} / {{ total_questions|default:50 }}</div>
                        <div class="t">باقي {{ a.remaining_q|default:0 }}</div>
                      </div>
                    </div>
                  </td>

                  <td class="col-score">
                    <span class="bi-chip">
                      {% if a.is_finished %}{{ a.score|default:0 }}{% else %}—{% endif %}
                    </span>
                  </td>

                  <td class="col-time">
                    <span class="bi-chip">{% if a.started_at %}{{ a.started_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</span>
                  </td>

                  <td class="col-ip">
                    <span class="bi-chip">{{ a.started_ip|default:"—" }}</span>
                  </td>

                  <td class="col-act">
                    <div class="bi-act">
                      <a class="bi-btn" href="{% url 'quiz:staff_attempt_detail' a.id %}">تفاصيل</a>

                      {% if not a.is_finished %}
                        <a class="bi-btn red" href="{% url 'quiz:staff_attempt_finish_confirm' a.id %}">إنهاء</a>
                      {% endif %}

                      <a class="bi-btn" href="{% url 'quiz:staff_attempt_reset_confirm' a.id %}">إعادة</a>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="9" style="padding:16px;color:var(--bi-mut);font-weight:900">
                    لا توجد نتائج ضمن الفلاتر الحالية.
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pager -->
        <div class="bi-pager">
          <div class="info">
            الصفحة {{ attempts.number }} من {{ attempts.paginator.num_pages }} — إجمالي النتائج: {{ attempts.paginator.count }}
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            {% if attempts.has_previous %}
              <a class="bi-pbtn" href="?page=1">الأولى</a>
              <a class="bi-pbtn" href="?page={{ attempts.previous_page_number }}">السابق</a>
            {% endif %}

            {% if attempts.has_next %}
              <a class="bi-pbtn" href="?page={{ attempts.next_page_number }}">التالي</a>
              <a class="bi-pbtn" href="?page={{ attempts.paginator.num_pages }}">الأخيرة</a>
            {% endif %}
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
