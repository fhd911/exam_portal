{% extends "quiz/base.html" %}
{% load static %}

{% block title %}لوحة الإدارة — المحاولات{% endblock %}

{% block content %}
<div class="wrap" style="max-width:1180px;margin:0 auto;">

  <!-- رأس الصفحة -->
  <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-
wrap:wrap;margin-bottom:10px;">
    <div>
      <h1 style="margin:0;font-size:16px;font-weight:1000;letter-spacing:.2px;">
        لوحة الإدارة — {% if mode == "not_tested" %}لم يدخلوا الاختبار{% else %}المحاولات{% endif %}
      </h1>
      <div style="margin-top:6px;color:#607185;line-height:1.8;font-size:12px;">
        عرض جدولي رسمي (كل مرشح في صف) — خط صغير — بدون شارات مزعجة — مع فلاتر دقيقة.
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">

      {% if mode == "not_tested" %}
        <!-- ✅ زر الرجوع للوحة الإدارة (المحاولات) -->
        <a class="btn" href="{% url 'quiz:staff_manage' %}{% if qs_base_no_nt %}?{{ qs_base_no_nt }}{% endif %}"
           style="text-decoration:none;white-space:nowrap;background:rgba(245,246,255,.85);border:1px solid rgba(99,102,241,.25);color:#0f172a;font-weight:1000;">
          الرجوع للوحة الإدارة
        </a>
      {% endif %}

      <a class="btn" href="{% url 'quiz:staff_import_participants' %}" style="text-decoration:none;white-space:nowrap;">
        استيراد المرشحين
      </a>
      <a class="btn" href="{% url 'quiz:staff_import_questions' %}" style="text-decoration:none;white-space:nowrap;">
        استيراد الأسئلة
      </a>

      {% if mode == "attempts" %}
        <a class="btn" href="{% url 'quiz:staff_export_xlsx' %}?{{ qs_base }}"
           style="text-decoration:none;white-space:nowrap;background:rgba(240,255,247,.85);border:1px solid rgba(16,185,129,.25);color:#0f172a;font-weight:1000;">
          تصدير XLSX
        </a>
        <a class="btn" href="{% url 'quiz:staff_export_csv' %}?{{ qs_base }}"
           style="text-decoration:none;white-space:nowrap;background:rgba(245,246,255,.85);border:1px solid rgba(99,102,241,.25);color:#0f172a;font-weight:1000;">
          تصدير CSV
        </a>
      {% else %}
        <a class="btn" href="{% url 'quiz:staff_export_not_tested_xlsx' %}?{{ qs_base }}"
           style="text-decoration:none;white-space:nowrap;background:rgba(240,255,247,.85);border:1px solid rgba(16,185,129,.25);color:#0f172a;font-weight:1000;">
          تصدير غير المختبرين XLSX
        </a>
      {% endif %}
    </div>
  </div>

  <!-- KPI -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;">

    <div class="glass" style="
      background:rgba(255,255,255,.86);
      border:1px solid rgba(231,238,246,.95);
      border-radius:18px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    ">
      <div style="font-size:11px;color:#6b7a89;">إجمالي المرشحين (مسموح لهم)</div>
      <div style="margin-top:6px;font-size:18px;font-weight:1000;color:#0f172a;">
        {{ kpi_people.total_candidates|default:0 }}
      </div>
      <div style="margin-top:6px;color:#607185;font-size:11px;line-height:1.7;">
        يعتمد على Enrollment (is_allowed=True).
      </div>
    </div>

    <div class="glass" style="
      background:rgba(255,255,255,.86);
      border:1px solid rgba(231,238,246,.95);
      border-radius:18px;
      padding:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    ">
      <div style="font-size:11px;color:#6b7a89;">دخلوا الاختبار</div>
      <div style="margin-top:6px;font-size:18px;font-weight:1000;color:#0f172a;">
        {{ kpi_people.tested_candidates|default:0 }}
      </div>
      <div style="margin-top:6px;color:#607185;font-size:11px;line-height:1.7;">
        تم رصد Attempt واحد على الأقل.
      </div>
    </div>

    <!-- ✅ بطاقة قابلة للضغط بدون JS (فتح شاشة غير المختبرين) -->
    <a
      href="{% url 'quiz:staff_manage' %}{% if qs_base_no_nt %}?{{ qs_base_no_nt }}&amp;not_tested=1{% else %}?not_tested=1{% endif %}"
      class="glass"
      style="
        text-decoration:none; color:inherit;
        background:rgba(255,255,255,.86);
        border:1px solid rgba(231,238,246,.95);
        border-radius:18px;
        padding:12px;
        box-shadow:0 10px 30px rgba(0,0,0,.06);
        display:block;
        outline:none;
      "
    >
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div>
          <div style="font-size:11px;color:#6b7a89;">لم يدخلوا الاختبار</div>
          <div style="margin-top:6px;font-size:18px;font-weight:1000;color:#0f172a;">
            {{ kpi_people.not_tested_candidates|default:0 }}
          </div>
          <div style="margin-top:6px;color:#607185;font-size:11px;line-height:1.7;">
            اضغط لفتح عرض “لم يدخلوا” مباشرة + إمكانية تصديرهم.
          </div>
        </div>

        <div style="
          width:42px;height:42px;border-radius:14px;
          border:1px solid rgba(148,163,184,.35);
          display:flex;align-items:center;justify-content:center;
          background:rgba(250,251,255,.85);
          color:#334155;font-weight:1000;
        ">›</div>
      </div>
    </a>

  </div>

  <!-- ✅ إحصائية غير المختبرين حسب المجال -->
  {% if by_domain_not_tested %}
  <div class="glass" style="
    background:rgba(255,255,255,.86);
    border:1px solid rgba(231,238,246,.95);
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
    margin-bottom:10px;
  ">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
      <div style="font-weight:1000;font-size:13px;">إحصائية “غير المختبرين” حسب المجال</div>
      <div style="color:#6b7a89;font-size:11px;">عدد المرشحين المسموح لهم ولم يُسجل لهم أي Attempt.</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px;">
      {% for row in by_domain_not_tested %}
        <div style="
          border:1px solid rgba(148,163,184,.28);
          border-radius:16px;
          padding:10px;
          background:rgba(250,251,255,.85);
        ">
          <div style="font-size:11px;color:#607185;">{{ row.label|default:row.domain }}</div>
          <div style="margin-top:6px;font-size:16px;font-weight:1000;color:#0f172a;">
            {{ row.total|default:0 }}
          </div>
          <div style="margin-top:6px;font-size:11px;color:#6b7a89;">
            غير مختبرين
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- فلاتر -->
  <div class="glass" style="
    background:rgba(255,255,255,.86);
    border:1px solid rgba(231,238,246,.95);
    border-radius:18px;
    padding:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
    margin-bottom:10px;
  ">
    <form method="get" action="{% url 'quiz:staff_manage' %}" style="display:grid;grid-template-columns:1.1fr .8fr .8fr .9fr .7fr .7fr .9fr .9fr;gap:8px;align-items:end;">
      {% if mode == "not_tested" %}
        <input type="hidden" name="not_tested" value="1">
      {% endif %}

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">بحث (اسم/هوية)</label>
        <input name="q" value="{{ filters.q|default:'' }}" placeholder="اسم أو هوية"
               style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
      </div>

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">المجال</label>
        <select name="domain" style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
          <option value="">الكل</option>
          <option value="deputy" {% if filters.domain == "deputy" %}selected{% endif %}>وكيل</option>
          <option value="counselor" {% if filters.domain == "counselor" %}selected{% endif %}>موجّه طلابي</option>
          <option value="activity" {% if filters.domain == "activity" %}selected{% endif %}>نشاط</option>
        </select>
      </div>

      {% if mode == "attempts" %}
      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">الحالة</label>
        <select name="status" style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
          <option value="all" {% if filters.status == "all" %}selected{% endif %}>الكل</option>
          <option value="running" {% if filters.status == "running" %}selected{% endif %}>جارية</option>
          <option value="finished" {% if filters.status == "finished" %}selected{% endif %}>منتهية</option>
        </select>
      </div>

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">اختبار</label>
        <select name="quiz" style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
          <option value="">الكل</option>
          {% for qz in quizzes %}
            <option value="{{ qz.id }}" {% if filters.quiz|stringformat:"s" == qz.id|stringformat:"s" %}selected{% endif %}>{{ qz.title }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">مرشح؟</label>
        <select name="cand" style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
          <option value="">الكل</option>
          <option value="yes" {% if filters.cand == "yes" %}selected{% endif %}>نعم (>= {{ pass_score }})</option>
          <option value="no" {% if filters.cand == "no" %}selected{% endif %}>لا</option>
        </select>
      </div>

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">أقل درجة</label>
        <input name="min_score" value="{{ filters.min_score|default:'' }}" placeholder="مثال: 25"
               style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
      </div>

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">من</label>
        <input name="from" value="{{ filters.from|default:'' }}" type="date"
               style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
      </div>

      <div>
        <label style="display:block;font-size:11px;color:#607185;margin-bottom:5px;">إلى</label>
        <input name="to" value="{{ filters.to|default:'' }}" type="date"
               style="width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(148,163,184,.35);font-size:12px;outline:none;">
      </div>
      {% else %}
        <div style="grid-column:span 5;color:#607185;font-size:11px;align-self:center;">
          هذا العرض يظهر فقط المرشحين (Enrollment) المسموح لهم ولم يُسجل لهم أي Attempt.
        </div>
      {% endif %}

      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button class="btn" type="submit" style="white-space:nowrap;">تطبيق</button>

        {% if mode == "not_tested" %}
          <a class="btn" href="{% url 'quiz:staff_manage' %}?not_tested=1"
             style="text-decoration:none;white-space:nowrap;background:#f7fafc;border:1px solid rgba(148,163,184,.35);color:#0f172a;">
            تصفير
          </a>
        {% else %}
          <a class="btn" href="{% url 'quiz:staff_manage' %}"
             style="text-decoration:none;white-space:nowrap;background:#f7fafc;border:1px solid rgba(148,163,184,.35);color:#0f172a;">
            تصفير
          </a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- جدول -->
  <div class="glass" style="
    background:rgba(255,255,255,.86);
    border:1px solid rgba(231,238,246,.95);
    border-radius:18px;
    padding:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.06);
  ">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:2px 4px 10px;">
      <div style="font-weight:1000;font-size:13px;">
        {% if mode == "not_tested" %}قائمة لم يدخلوا الاختبار{% else %}قائمة المحاولات{% endif %}
      </div>
      <div style="color:#6b7a89;font-size:11px;">
        {% if mode == "not_tested" %}
          اضغط “تصدير غير المختبرين” بالأعلى لتحميل ملف الإكسل.
        {% else %}
          اضغط رقم المحاولة لفتح التفاصيل.
        {% endif %}
      </div>
    </div>

    <div style="overflow:visible;">
      <table style="width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;">
        <thead>
          <tr>
            <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:70px;">#</th>
            <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);">الاسم</th>
            <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:140px;">الهوية</th>
            <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:140px;">المجال</th>

            {% if mode == "attempts" %}
              <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:110px;">الدرجة</th>
              <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:110px;">مرشح؟</th>
              <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:170px;">البدء</th>
              <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:120px;">الحالة</th>
            {% else %}
              <th style="text-align:right;font-size:11px;color:#607185;font-weight:900;padding:8px;border-bottom:1px solid rgba(180,190,205,.35);width:160px;">الحالة</th>
            {% endif %}
          </tr>
        </thead>

        <tbody>
          {% if mode == "attempts" %}
            {% for a in attempts %}
              <tr>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  <a href="{% url 'quiz:staff_attempt_detail' a.id %}" style="text-decoration:none;font-weight:1000;color:#0f172a;">
                    {{ a.id }}
                  </a>
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;line-height:1.8;word-wrap:break-word;">
                  {{ a.participant.full_name }}
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {{ a.participant.national_id }}
                </td>

                <!-- ✅ المجال بالعربي -->
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {% if a.domain == "deputy" %}وكيل
                  {% elif a.domain == "counselor" %}موجّه طلابي
                  {% elif a.domain == "activity" %}رائد نشاط
                  {% else %}{{ a.domain }}
                  {% endif %}
                </td>

                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {{ a.display_score|default:a.score|default:0 }}
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {% if a.is_finished and a.score|default:0 >= pass_score %}
                    <span style="color:#0f766e;font-weight:900;">نعم</span>
                  {% elif a.is_finished %}
                    <span style="color:#b42318;font-weight:900;">لا</span>
                  {% else %}
                    <span style="color:#607185;">—</span>
                  {% endif %}
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {% if a.started_at %}{{ a.started_at|date:"Y-m-d H:i" }}{% else %}-{% endif %}
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {% if a.is_finished %}
                    <span style="color:#0f172a;font-weight:900;">منتهية</span>
                  {% else %}
                    <span style="color:#0f172a;">جارية</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" style="padding:14px;text-align:center;color:#6b7a89;font-size:12px;">
                  لا توجد محاولات مطابقة للفلاتر الحالية.
                </td>
              </tr>
            {% endfor %}
          {% else %}
            {% for e in not_tested %}
              <tr>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {{ forloop.counter }}
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;line-height:1.8;word-wrap:break-word;">
                  {{ e.participant.full_name }}
                </td>
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {{ e.participant.national_id }}
                </td>

                <!-- ✅ المجال بالعربي -->
                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;">
                  {% if e.domain == "deputy" %}وكيل
                  {% elif e.domain == "counselor" %}موجّه طلابي
                  {% elif e.domain == "activity" %}رائد نشاط
                  {% else %}{{ e.domain }}
                  {% endif %}
                </td>

                <td style="padding:8px;border-bottom:1px solid rgba(225,232,240,.75);font-size:11px;vertical-align:top;color:#6b7a89;">
                  لم يدخل الاختبار
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" style="padding:14px;text-align:center;color:#6b7a89;font-size:12px;">
                  لا يوجد “غير مختبرين” حسب الفلاتر الحالية.
                </td>
              </tr>
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <div style="color:#6b7a89;font-size:11px;">
        {% if mode == "attempts" %}
          صفحة {{ attempts.number }} من {{ attempts.paginator.num_pages }}
        {% else %}
          صفحة {{ not_tested.number }} من {{ not_tested.paginator.num_pages }}
        {% endif %}
      </div>

      <div style="display:flex;gap:6px;flex-wrap:wrap;">

        {% if mode == "attempts" %}
          {% if attempts.has_previous %}
            <a class="btn"
               style="text-decoration:none;background:#f7fafc;border:1px solid rgba(148,163,184,.35);"
               href="?{{ qs_base }}&amp;page={{ attempts.previous_page_number }}">السابق</a>
          {% endif %}
          {% if attempts.has_next %}
            <a class="btn"
               style="text-decoration:none;background:#f7fafc;border:1px solid rgba(148,163,184,.35);"
               href="?{{ qs_base }}&amp;page={{ attempts.next_page_number }}">التالي</a>
          {% endif %}
        {% else %}
          {% if not_tested.has_previous %}
            <a class="btn"
               style="text-decoration:none;background:rgba(240,255,247,.9);border:1px solid rgba(16,185,129,.28);color:#0f172a;font-weight:1000;"
               href="?{{ qs_base }}&amp;page={{ not_tested.previous_page_number }}">السابق</a>
          {% endif %}
          {% if not_tested.has_next %}
            <a class="btn"
               style="text-decoration:none;background:rgba(245,246,255,.9);border:1px solid rgba(99,102,241,.28);color:#0f172a;font-weight:1000;"
               href="?{{ qs_base }}&amp;page={{ not_tested.next_page_number }}">التالي</a>
          {% endif %}
        {% endif %}

      </div>
    </div>

  </div>

</div>
{% endblock %}
